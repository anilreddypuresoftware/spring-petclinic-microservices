# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven

name: Java CI with Maven

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:

    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ '17' ]

    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK ${{matrix.java}}
      uses: actions/setup-java@v2
      with:
        java-version: ${{matrix.java}}
        distribution: 'adopt'
        cache: maven
    - name: Build with Maven
      run: mvn -B package --file pom.xml
      
  armv64_job:
      name: Build and Test for arm64
      runs-on: ubuntu-20.04
      steps:
        - uses: actions/checkout@v2
        - name: Set up QEMU
          id: qemu
          uses: docker/setup-qemu-action@v1
        - name: Install and Run tests
          run: |
            docker run --rm -v ${{ github.workspace }}:/ws:rw --workdir=/ws \
              arm64v8/ubuntu:20.04 \
              bash -exc 'apt-get update && apt-get -y install curl sudo wget && \
              sudo apt install -y openjdk-17-jdk && \   
              export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-arm64 && \
              export PATH=$JAVA_HOME/bin:$PATH && \
              java -version && \
              update-alternatives --config java && \
              wget https://dlcdn.apache.org/maven/maven-3/3.9.1/binaries/apache-maven-3.9.1-bin.tar.gz && \
              tar -xvf apache-maven-3.9.1-bin.tar.gz && \
              sudo mv apache-maven-3.9.1 /opt/ && \
              M2_HOME='/opt/apache-maven-3.9.1' && \
              PATH="$M2_HOME/bin:$PATH" && \
              export PATH && \
              sudo ln -s /opt/apache-maven-3.9.1/bin/mvn /usr/bin/mvn && \
              mvn -version && \
              mvn -B package --file pom.xml && \
              deactivate'
